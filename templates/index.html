<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <meta name="vieewport" content="wiidth=device-width, initial-scale=1.0">
        <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

    </head>
    <body>
        <nav>
            <div class="nav-wrapper">
              <a href="#" class="brand-logo right">Logo</a>
              <ul id="nav-mobile" class="left hide-on-med-and-down">
                <li><a href="sass.html">Sass</a></li>
                <li><a href="badges.html">Components</a></li>
                <li><a href="collapsible.html">JavaScript</a></li>
              </ul>
            </div>
        </nav>
        <div class="container">
            <h3>Add Node</h3>
            
            <div class="row">
                <form class="col s12">
                  <div class="row">
                    <div class="input-field col s12">
                      <input id="host" value="127.0.0.1" type="text" class="validate">
                      <label for="host">Host</label>
                    </div>
                  </div>
                  <div class="row">
                    <div class="input-field col s12">
                      <input id="port" type="text" class="validate">
                      <label for="port">Port(e.g.5001)</label>
                    </div>
                  </div>
                  <a id="register_node" class="waves-effect waves-light btn">Register Node</a>
                </form>
            <div id="node_message"></div>
            </div>
            
            <div class="row">
                <form class="col s12"><!--todo-->
                <h3>Wallet</h3>
                  <div class="row">
                    <div class="input-field col s12">
                      <input id="add_wallet_amount" type="number" class="validate">
                      <label for="add_wallet_amount">Amount</label>
                    </div>
                  </div>
                  <a id="topup_wallet" class="waves-effect waves-light btn">Add Balance To Wallet</a>
                  <a id="check_wallet" class="waves-effect waves-light btn">Check Wallet Balance</a>
                </form>
                <div id="add_wallet_amount_message"></div>
                <div>
                    <table id="wallet_table"><thead><tr><th>Wallet:</th></tr></thead>
                    </table>
                </div>
            </div>
            <!-- show balance
            add balance -->
            
            <div class="row">
                <form class="col s12">
                <h3>Make New Transactions</h3>
                  <div class="row">
                    <div class="input-field col s12">
                      <input id="recipient_address" type="text" class="validate">
                      <label for="recipient_address">Recipient address</label>
                    </div>
                  </div>
                  <div class="row">
                    <div class="input-field col s12">
                      <input id="amount" type="number" class="validate">
                      <label for="amount">Amount</label>
                    </div>
                  </div>
                  <a id="new_transaction" class="waves-effect waves-light btn">Make New Transaction</a>
                </form>
                <div id="new_transaction_message"></div>
                <div id="new_transaction_warning"></div>
            </div>
            
            <div class="row">
                <form class="col s12">
                <h3>Get Transactions</h3>
                <a id="get_transactions" class="waves-effect waves-light btn">Get Transactions</a>
                </form>
                <div>
                    <h3>Transaction Record:</h3>
                    <table id="transaction_table">
                        <thead>
                            <tr><th> Sender:</th><th> Recipient:</th><th> Value:</th><th> Signature:</th></tr>
                        </thead>
                    </table>
                </div>
            </div>
            <div class="row">
                <form class="col s12">
                <h3>Get chain</h3><!--todo-->
                <a id="get_chain" class="waves-effect waves-light btn">Get Chain</a>
                <div id="chain"></div><!-- visualise -->
                </form>
            </div>
            
            
            <div class="row">
                <form class="col s12">
                <h3>Consensus</h3>
                <a id="consensus" class="waves-effect waves-light btn">Get consensus</a>
                <div id="consensus_message"></div>
                </form>
            </div>
            
            <div class="row">
                <form class="col s12">
                    <h3>Mine</h3>
                <a id="mine" class="waves-effect waves-light btn">Mine</a>
                <ul id="mine_table" class="collection with-header"></ul>
                <div id="mine_message"></div>
                </form>
            </div>

            <!-- <div class="row">
                <form class="col s12">
                    <h3>Interest</h3>
                <a id="interest" class="waves-effect waves-light btn">Interest</a>
                <ul id="interest_table" class="collection with-header"></ul>
                <div id="interest_message"></div>
                </form>
            </div> -->
        </div>
        <!-- Compiled and minified CSS -->
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
        <!-- Compiled and minified JavaScript -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
        <script>
        // var SendInfo= { SendInfo: $("#wallet_amount")};
        $(document).ready(function () {
            $("#register_node").click(function (e) {
                var host = document.getElementById("host").value;
                var port = parseInt(document.getElementById("port").value);

                var server_data = {
                    "host": host,
                    "port": port,
                };
                $.ajax({
                    type: "POST",
                    // url: "http://127.0.0.1:"+port+"/register_node",
                    url: "http://127.0.0.1:5000/register_node",
                    data: JSON.stringify(server_data),
                    contentType: "application/json",
                    dataType: "json",
                    success: function (result, status) {
                        var message = result["message"];
                        var table = $("<table><thead><tr><th></th></tr></thead>");
                        table.append("<tbody>");
                        for(var i in result["my_transactions_record"]){
                            table.append("<tr><td>Transaction "+ i +":</td><td>" + result["my_transactions_record"][i] + "</td></tr>");
                        }
                        table.append("</tbody>");
                        $("#node_table").html(table);
                        $("#node_message").html(message);
                    },
                    error: function (xhr, status, error) {
                        alert("Result: " + status + " " + error + " " + xhr.status + " " + xhr.statusText)
                    }
                });
            });
            $("#mine").click(function (e) {
                $.ajax({
                    type: "GET",
                    // url: "http://127.0.0.1:"+port+"/register_node",
                    url: "http://127.0.0.1:5000/mine",
                    dataType: "json",
                    success: function (result, status) {
                        var message = result["message"];
                        if(message){
                            $("#mine_message").html(message);
                        }else{
                            var list = $("#mine_table");
                            list.append("<li class=\"collection-header\"><h4>New Block</h4></li>");
                            list.append("<li class=\"collection-item\"><div>Index<div class=\"secondary-content\">"+result["index"]+ "</div></div></li>");
                            list.append("<li class=\"collection-item\"><div>Transactions<div class=\"secondary-content\">"+result["transactions"]+ "</div></div></li>");
                            list.append("<li class=\"collection-item\"><div>Timestamp<div class=\"secondary-content\">"+result["timestamp"]+ "</div></div></li>");
                            list.append("<li class=\"collection-item\"><div>Previous_hash<div class=\"secondary-content\">"+result["previous_hash"]+ "</div></div></li>");
                            list.append("<li class=\"collection-item\"><div>Hash<div class=\"secondary-content\">"+result["hash"]+ "</div></div></li>");
                            list.append("<li class=\"collection-item\"><div>Nonce<div class=\"secondary-content\">"+result["nonce"]+ "</div></div></li>");
                            list.append("<li class=\"collection-item\"><div>Difficulty<div class=\"secondary-content\">"+result["difficulty"]+ "</div></div></li>");
                        }
                    },
                    error: function (xhr, status, error) {
                        alert("Result: " + status + " " + error + " " + xhr.status + " " + xhr.statusText)
                    }
                });
            });
            $("#consensus").click(function (e) {
                $.ajax({
                    type: "GET",
                    // url: "http://127.0.0.1:"+port+"/register_node",
                    url: "http://127.0.0.1:5000/consensus",
                    dataType: "json",
                    success: function (result, status) {
                        var message = result["message"];
                        $("#consensus_message").html(message);
                    },
                    error: function (xhr, status, error) {
                        alert("Result: " + status + " " + error + " " + xhr.status + " " + xhr.statusText)
                    }
                });
            });
            $("#check_wallet").click(function (e) {
                $.ajax({
                    type: "GET",
                    // url: "http://127.0.0.1:"+port+"/register_node",
                    url: "http://127.0.0.1:5000/myWallet/wallet",
                    dataType: "json",
                    success: function (result, status) {
                        var table = $("#wallet_table");
                        table.append("<tbody>");
                        table.append("<tr><td>Public Key:</td><td>" + result["public_key"] + "</td></tr>");
                        table.append("<tr><td>Private Key:</td><td>" + result["private_key"] + "</td></tr>");
                        table.append("<tr><td>Balance:</td><td>" + result["balance"] + "</td></tr>");
                        table.append("</tbody>");
                    },
                    error: function (xhr, status, error) {
                        alert("Result: " + status + " " + error + " " + xhr.status + " " + xhr.statusText)
                    }
                });
            });
            $("#topup_wallet").click(function (e) {
                var amount = parseInt(document.getElementById("add_wallet_amount").value);
                var server_data = {
                    "amount": amount,
                };
                $.ajax({
                    type: "POST",
                    // url: "http://127.0.0.1:"+port+"/register_node",
                    url: "http://127.0.0.1:5000/myWallet/wallet",
                    data: JSON.stringify(server_data),
                    contentType: "application/json",
                    dataType: "json",
                    success: function (result, status) {
                        var message = result["message"];
                        $("#add_wallet_amount_message").html(message);

                    },
                    error: function (xhr, status, error) {
                        alert("Result: " + status + " " + error + " " + xhr.status + " " + xhr.statusText)
                    }
                });
            });
            $("#new_transaction").click(function (e) {
                var recipient_address = document.getElementById("recipient_address").value;
                var amount = parseInt(document.getElementById("amount").value);

                var server_data = {
                    "recipient_address":recipient_address,
                    "amount": amount,
                };
                $.ajax({
                    type: "POST",
                    // url: "http://127.0.0.1:"+port+"/register_node",
                    url: "http://127.0.0.1:5000/new_transaction",
                    dataType: "json",
                    data: JSON.stringify(server_data),
                    contentType: "application/json",
                    success: function (result, status) {
                        var message = result["message"];
                        var warning = result["reminder"]|result["warning"];
                        $("#new_transaction_message").html(message);
                        $("#new_transaction_warning").html(warning);
                    },
                    error: function (xhr, status, error) {
                        alert("Result: " + status + " " + error + " " + xhr.status + " " + xhr.statusText)
                    }
                });
            });
            $("#get_transactions").click(function (e) {
                $.ajax({
                    type: "GET",
                    url: "http://127.0.0.1:5000/get_transactions",
                    // url: "http://127.0.0.1:"+port+"/get_transactions",
                    dataType: "json",
                    success: function (result, status) {
                        var table = $("#transaction_table");
                        table.append("<tbody>");

                        for(var i in result["my_transactions_record"]){
                            table.append("<tr><td>" + result["my_transactions_record"][i]["sender"] + "</td>"+"<td>" + result["my_transactions_record"][i]["recipient"] + "</td>"+"<td>" + result["my_transactions_record"][i]["value"] + "</td>"+"<td>" + result["my_transactions_record"][i]["signature"] + "</td>"+"</tr>");
                        }
                        table.append("</tbody>");

                        $("#transactions").html(table);
                    },
                    error: function (xhr, status, error) {
                        alert("Result: " + status + " " + error + " " + xhr.status + " " + xhr.statusText)
                    }
                });
            });
            $(document).ajaxStart(function () {
                $("img").show();
            });
        
            $(document).ajaxStop(function () {
                $("img").hide();
            });
        });
        </script>
    </body>
</html>