<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <meta name="vieewport" content="wiidth=device-width, initial-scale=1.0">
        <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
        <link type="text/css" rel="stylesheet" href="css/materialize.min.css"  media="screen,projection"/>
        <style>
            div {overflow-wrap: break-word;}
        </style>
    </head>
    <body>
        <nav>
            <div class="nav-wrapper">
              <a href="#" class="brand-logo right">Logo</a>
              <ul id="nav-mobile" class="left hide-on-med-and-down">
                <!-- <li><a href="sass.html">Sass</a></li>
                <li><a href="badges.html">Components</a></li>
                <li><a href="collapsible.html">JavaScript</a></li> -->
              </ul>
            </div>
        </nav>
        <div class="container">
            <div class="row">
                <div class="col s12">
                  <ul class="tabs">
                    <li class="tab col s3"><a href="#test1">Add node</a></li>
                    <li class="tab col s3"><a class="active" href="#test2">Wallet</a></li>
                    <li class="tab col s3 "><a href="#test3">Transactions</a></li>
                    <li class="tab col s3"><a href="#test4">Mine/View</a></li>
                  </ul>
                </div>
                <div id="test1" class="col s12">
                    <h6>Add Node</h6>
            
            <div class="row">
                <form class="col s12">
                  <div class="row">
                    <div class="input-field col s12">
                      <input id="host" value="127.0.0.1" type="text" class="validate">
                      <label for="host">Host</label>
                    </div>
                  </div>
                  <div class="row">
                    <div class="input-field col s12">
                      <input id="port" type="text" class="validate">
                      <label for="port">Port(e.g.5001)</label>
                    </div>
                  </div>
                  <a id="register_node" class="waves-effect waves-light btn">Register Node</a>
                </form>
                    <div id="node_message"></div>
                    <div id="node_table" class="col s12"></div>
                    <div id="all_node"></div>
                </div>
                </div>
                
                <div id="test2" class="col s12">
                    <div class="row">
                        <form class="col s12"><!--todo-->
                            <div class="card-panel">
                            <h6>Wallet</h6>
                            <div class="row">
                                <div class="input-field col s12">
                                <input id="add_wallet_amount" type="number" class="validate">
                                <label for="add_wallet_amount">Amount</label>
                                </div>
                            </div>
                            </div>
                          <a id="topup_wallet" class="waves-effect waves-light btn">Add Balance To Wallet</a>
                          <a id="check_wallet" class="waves-effect waves-light btn">Check Wallet Balance</a>
                        </form>
                        <div id="add_wallet_amount_message"></div>
                        <div class="col s12">
                            <div class="card-panel">
                            <div id="wallet_table"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="test3" class="col s12">
                    <div class="row">
                        <form class="col s12">
                        <h6>Make New Transactions</h6>
                          <div class="row">
                            <div class="input-field col s12">
                              <input id="recipient_address" type="text" class="validate">
                              <label for="recipient_address">Recipient address</label>
                            </div>
                          </div>
                          <div class="row">
                            <div class="input-field col s12">
                              <input id="amount" type="number" class="validate">
                              <label for="amount">Amount</label>
                            </div>
                          </div>
                          <a id="new_transaction" class="waves-effect waves-light btn">Make New Transaction</a>
                        </form>
                        <div id="new_transaction_message"></div>
                        <div id="new_transaction_warning"></div>
                    </div>
                    <div class="divider"></div>
                    <div class="row">
                        <form class="col s12">
                        <h6>Get Transactions</h6>
                        <a id="get_transactions" class="waves-effect waves-light btn">Get Transactions</a>
                        </form>
                        <div class="col s12">
                            <table id="transaction_table">
                                <h6>Transaction Record:</h6>
                                <thead>
                                    <tr><th> Sender:</th><th> Recipient:</th><th> Value:</th><th> Signature:</th></tr>
                                </thead>
                            </table>
                            
                            <table id="transaction_table">
                                <h6>My Transaction Record:</h6>
                                <thead>
                                    <tr><th> Sender:</th><th> Recipient:</th><th> Value:</th><th> Signature:</th></tr>
                                </thead>
                            </table>
                        </div>
                    </div>
                </div>
                <div id="test4" class="col s12">
                
                
                
                <div class="row">
                    <form class="col s12">
                    <h6>Consensus</h6>
                    <a id="consensus" class="waves-effect waves-light btn">Get consensus</a>
                    <div id="consensus_message"></div>
                    </form>
                </div>
                <div class="divider"></div>
                <div class="row">
                    <form class="col s12">
                        <h6>Mine</h6>
                    <a id="mine" class="waves-effect waves-light btn">Mine</a>
                    <ul id="mine_table" class="collection with-header"></ul>
                    <div id="mine_message"></div>
                    </form>
                </div>
                <div class="divider"></div>
                <div class="row">
                    <form class="col s12">
                    <h6>Get chain</h6><!--todo-->
                    <a id="get_chain" class="waves-effect waves-light btn">Get Chain</a>
                    <div id="chain_table">
                    </div><!-- visualise -->
                    </form>
                </div>
                <div class="divider"></div>
            </div>
              </div>
            
            

            <!-- <div class="row">
                <form class="col s12">
                    <h6>Interest</h6>
                <a id="interest" class="waves-effect waves-light btn">Interest</a>
                <ul id="interest_table" class="collection with-header"></ul>
                <div id="interest_message"></div>
                </form>
            </div> -->
        </div>
        <!-- Compiled and minified CSS -->
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
        <!-- Compiled and minified JavaScript -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
        <script>
        M.AutoInit();
        $(document).ready(function () {
            $("#register_node").click(function (e) {
                var host = document.getElementById("host").value;
                var port = parseInt(document.getElementById("port").value);

                var server_data = {
                    "host": host,
                    "port": port,
                };
                $.ajax({
                    type: "POST",
                    // url: "http://127.0.0.1:"+port+"/register_node",
                    url: "http://127.0.0.1:5000/register_node",
                    data: JSON.stringify(server_data),
                    contentType: "application/json",
                    dataType: "json",
                    success: function (result, status) {
                        var message = result["message"];
                        var chain = result["blockchain"];
                        var nodes = result["total_nodes"];
                        var all_node = "";

                        
                        for(var i in chain){
                            var record = chain[i];
                            var transaction = JSON.parse(record["transactions"][0]);
                            var template_table = '<div id="chain" class="card-panel"><div class="row"><div class="col s4 push-s8"><span class="flow-text">Index:'+ record.index+'</span></div><div class="col s8 pull-s4">Timestamp:'+ record.timestamp+'<br>Previous hash:'+ record.previous_hash+'<br>hash:'+ record.hash+'<br>Nonce:'+ record.nonce+'<br>Difficulty:'+ record.difficulty+'<br> </div></div><div class="divider"></div><div class="section"><h5>Transaction</h5><p>Sender:'+ transaction.sender+'<br><br>Recipient:'+ transaction.recipient+'<br><br>Value:'+ transaction.value+'<br></p></div><div class="divider"></div>';
                            $("#node_table").append(template_table);
                        }

                        for(var i in nodes){
                            all_node += nodes[i] + "<br>";
                        }

                        $("#node_message").html(message);
                        $("#all_node").html(all_node);
                    
                    },
                    error: function (xhr, status, error) {
                        alert("Result: " + status + " " + error + " " + xhr.status + " " + xhr.statusText)
                    }
                });
            });
            $("#mine").click(function (e) {
                $.ajax({
                    type: "GET",
                    // url: "http://127.0.0.1:"+port+"/register_node",
                    url: "http://127.0.0.1:5000/mine",
                    dataType: "json",
                    success: function (result, status) {
                        var message = result["message"];
                        if(message){
                            $("#mine_message").html(message);
                        }else{
                            var list = $("#mine_table");
                            list.append("<li class=\"collection-header\"><h6>New Block</h6></li>");
                            list.append("<li class=\"collection-item\"><div>Index:<div class=\"secondary-content\"> "+result["index"]+ " </div></div></li>");
                            list.append("<li class=\"collection-item\"><div>Transactions:<div class=\"secondary-content\">"+result["transactions"]+ "</div></div></li>");
                            list.append("<li class=\"collection-item\"><div>Timestamp:<div class=\"secondary-content\">"+result["timestamp"]+ "</div></div></li>");
                            list.append("<li class=\"collection-item\"><div>Previous_hash:<div class=\"secondary-content\">"+result["previous_hash"]+ "</div></div></li>");
                            list.append("<li class=\"collection-item\"><div>Hash:<div class=\"secondary-content\">"+result["hash"]+ "</div></div></li>");
                            list.append("<li class=\"collection-item\"><div>Nonce:<div class=\"secondary-content\">"+result["nonce"]+ "</div></div></li>");
                            list.append("<li class=\"collection-item\"><div>Difficulty:<div class=\"secondary-content\">"+result["difficulty"]+ "</div></div></li>");
                        }
                    },
                    error: function (xhr, status, error) {
                        alert("Result: " + status + " " + error + " " + xhr.status + " " + xhr.statusText)
                    }
                });
            });
            $("#consensus").click(function (e) {
                $.ajax({
                    type: "GET",
                    // url: "http://127.0.0.1:"+port+"/register_node",
                    url: "http://127.0.0.1:5000/consensus",
                    dataType: "json",
                    success: function (result, status) {
                        var message = result["message"];
                        $("#consensus_message").html(message);
                    },
                    error: function (xhr, status, error) {
                        alert("Result: " + status + " " + error + " " + xhr.status + " " + xhr.statusText)
                    }
                });
            });
            $("#check_wallet").click(function (e) {
                $.ajax({
                    type: "GET",
                    // url: "http://127.0.0.1:"+port+"/register_node",
                    url: "http://127.0.0.1:5000/myWallet/wallet",
                    dataType: "json",
                    success: function (result, status) {
                        var table = $("#wallet_table");
                        var template = '<div class="section"><h5>Public Key:</h5><p>Sender:'+ result["public_key"] +'<br><br><h5>Private Key:</h5><p>'+ result["private_key"] +'<br><br><h5>Balance:</h5><p>'+ result["balance"] +'<br></p><div class="divider"></div></div>';
                        table.html(template);
                    },
                    error: function (xhr, status, error) {
                        alert("Result: " + status + " " + error + " " + xhr.status + " " + xhr.statusText)
                    }
                });
            });
            $("#topup_wallet").click(function (e) {
                var amount = parseInt(document.getElementById("add_wallet_amount").value);
                var server_data = {
                    "amount": amount,
                };
                $.ajax({
                    type: "POST",
                    // url: "http://127.0.0.1:"+port+"/register_node",
                    url: "http://127.0.0.1:5000/myWallet/wallet",
                    data: JSON.stringify(server_data),
                    contentType: "application/json",
                    dataType: "json",
                    success: function (result, status) {
                        var message = result["message"];
                        $("#add_wallet_amount_message").html(message);

                    },
                    error: function (xhr, status, error) {
                        alert("Result: " + status + " " + error + " " + xhr.status + " " + xhr.statusText)
                    }
                });
            });
            $("#new_transaction").click(function (e) {
                var recipient_address = document.getElementById("recipient_address").value;
                var amount = parseInt(document.getElementById("amount").value);

                var server_data = {
                    "recipient_address":recipient_address,
                    "amount": amount,
                };
                $.ajax({
                    type: "POST",
                    // url: "http://127.0.0.1:"+port+"/register_node",
                    url: "http://127.0.0.1:5000/new_transaction",
                    dataType: "json",
                    data: JSON.stringify(server_data),
                    contentType: "application/json",
                    success: function (result, status) {
                        var message = result["message"];
                        var warning = result["reminder"]|result["warning"];
                        $("#new_transaction_message").html(message);
                        $("#new_transaction_warning").html(warning);
                    },
                    error: function (xhr, status, error) {
                        alert("Result: " + status + " " + error + " " + xhr.status + " " + xhr.statusText)
                    }
                });
            });
            $("#get_transactions").click(function (e) {
                $.ajax({
                    type: "GET",
                    url: "http://127.0.0.1:5000/get_transactions",
                    // url: "http://127.0.0.1:"+port+"/get_transactions",
                    dataType: "json",
                    success: function (result, status) {
                        var transaction_table = $("#transaction_table");
                        var my_transaction_table = $("#my_transaction_table");
                        transaction_table.append("<tbody>");

                        for(var i in result["transactions"]){
                            var transaction = JSON.parse(result["transactions"][i]);
                            transaction_table.append("<tr><td>" + transaction["sender"] + "</td>"+"<td>" + transaction["recipient"] + "</td>"+"<td>" + transaction["value"] + "</td>"+"<td>" + transaction["signature"] + "</td>"+"</tr>");
                        }
                        transaction_table.append("</tbody>");
                        my_transaction_table.append("<tbody>");

                        for(var i in result["my_transactions_record"]){
                            var transaction = JSON.parse(result["my_transactions_record"][i]);
                            my_transaction_table.append("<tr><td>" + transaction["sender"] + "</td>"+"<td>" + transaction["recipient"] + "</td>"+"<td>" + transaction["value"] + "</td>"+"<td>" + transaction["signature"] + "</td>"+"</tr>");
                        }
                        my_transaction_table.append("</tbody>");

                    },
                    error: function (xhr, status, error) {
                        alert("Result: " + status + " " + error + " " + xhr.status + " " + xhr.statusText)
                    }
                });
            });
            $("#get_chain").click(function (e) {
                $.ajax({
                    type: "GET",
                    url: "http://127.0.0.1:5000/chain",
                    // url: "http://127.0.0.1:"+port+"/get_transactions",
                    dataType: "json",
                    success: function (result, status) {
                        var chain_table = $("#chain_table");
                        var chain = result["chain"];
                        var record = JSON.parse(chain[0]);
                        // $("#chain").html(record["transactions"][0]);
                        for(var i in chain){
                            var record = JSON.parse(chain[i]);
                            var transaction = JSON.parse(record["transactions"][0]);
                            var template_table = '<div id="chain" class="card-panel"><div class="row"><div class="col s4 push-s8"><span class="flow-text">Index:'+ record.index+'</span></div><div class="col s8 pull-s4">Timestamp:'+ record.timestamp+'<br>Previous hash:'+ record.previous_hash+'<br>hash:'+ record.hash+'<br>Nonce:'+ record.nonce+'<br>Difficulty:'+ record.difficulty+'<br> </div></div><div class="divider"></div><div class="section"><h5>Transaction</h5><p>Sender:'+ transaction.sender+'<br><br>Recipient:'+ transaction.recipient+'<br><br>Value:'+ transaction.value+'<br></p><div class="divider"></div></div>';
                            chain_table.append(template_table);                            
                        }
                    },
                    error: function (xhr, status, error) {
                        alert("Result: " + status + " " + error + " " + xhr.status + " " + xhr.statusText)
                    }
                });
            });
        });
        </script>
    </body>
</html>